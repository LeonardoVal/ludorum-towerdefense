//! ludorum-towerdefense 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","inveniemus"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("inveniemus")):this["ludorum-towerdefense"]=e(this.base,this.Sermat,this.inveniemus)}).call(this,function(e,t,i){"use strict";var n,s,r,o=e.declare,a={},h=a.constants={ticks:25,money:99,hitpoints:10,mediPackCost:20,mediPackFactor:1,mediPackHealth:1,towerBuildCost:5,towerBuildFactor:1,towerBuildNumber:10},u=a.events={click:"click",mousemove:"mousemove",mouseover:"mouseover",mouseout:"mouseout",contextmenu:"contextmenu",died:"died",shot:"shot",hit:"hit",accomplished:"accomplished",playerDefeated:"playerDefeated",moneyChanged:"moneyChanged",waveCreated:"waveCreated",waveFinished:"waveFinished",waveDefeated:"waveDefeated",healthChanged:"healthChanged",unitSpawned:"unitSpawned",towerNumberChanged:"towerNumberChanged"},d=a.Class=(n=!1,s=/\b_super\b/,(r=function(){}).extend=function(e,t){var i=this.prototype;n=!0;var r=new this;for(var o in n=!1,e)r[o]="function"==typeof e[o]&&"function"==typeof i[o]&&s.test(e[o])?function(e,t){return function(){var n=this._super;this._super=i[e];var s=t.apply(this,arguments);return this._super=n,s}}(o,e[o]):e[o];var a=function(){!n&&this.init&&this.init.apply(this,arguments)};return(a.prototype=r).constructor=a,a.extend=this.extend,t&&"function"==typeof t&&t(a),a},r),c=a.MazeStrategy={manhattan:1,maxDXDY:2,diagonalShortCut:3,euclidean:4,euclideanNoSQR:5,custom:6,air:7},l=a.Direction={right:0,top:1,left:2,bottom:3},p=(a.Steps={WithDiagonals:[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],OnlyStraight:[[0,-1],[1,0],[0,1],[-1,0]]},a.Point=d.extend({init:function(e,t){this.x=e||0,this.y=t||0},clone:function(){return new p(this.x,this.y)},add:function(e){return new p(this.x+e.x,this.y+e.y)},subtract:function(e){return new p(this.x-e.x,this.y-e.y)},projectOn:function(e){return this.x*e.x+this.y*e.y},norm:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},square:function(){return this.x*this.x+this.y*this.y},scale:function(e){return new p(this.x*e,this.y*e)},normalize:function(){var e=1/this.norm();return this.scale(e)},regularize:function(){return 0===this.x&&0===this.y?new p(2*Math.round(Math.random())-1,2*Math.round(Math.random())-1):this},toDirection:function(){return this.x>this.y?this.x>-this.y?l.right:l.top:this.x>-this.y?l.bottom:l.left}})),m=a.Size=d.extend({init:function(e,t){this.width=e||0,this.height=t||0},clone:function(){return new m(this.width,this.height)},divide:function(e){return new m(this.width/e.width,this.height/e.height)}}),f=a.Maze=d.extend({init:function(e,t,i){this.gridDim=e;for(var n=[],s=0;s<e.width+1;s++){for(var r=[],o=0;o<e.height;o++)r.push(1);n.push(r)}this.grid=n,this.path=t,this.start=t[0],this.end=t[t.length-1],this.paths={},this.turrets=i},tryBuild:function(e,t){if(1!==this.grid[e.x][e.y])return!1;for(var i=0;i<this.turrets.length;i++)if(this.turrets[i].x==e.x&&this.turrets[i].y==e.y)return this.grid[e.x][e.y]=t||0,!0;return!1},tryRemove:function(e){return 1!==this.grid[e.x][e.y]&&(this.grid[e.x][e.y]=1,this.paths={},!0)},getPath:function(){return this.path}}),g=a.View=d.extend({init:function(e,t){this.running=!1,this.visuals=[],this.background=void 0,this.width=e,this.height=t,this.showGrid=!0,this.mazeSize=new m(25,25)},pause:function(){this.running=!1},add:function(e){if(Array.isArray(e))for(var t=0,i=e.length;t<i;++t)this.visuals.push(e[t]);else this.visuals.push(e);this.visuals.sort(function(e,t){return e.z-t.z})},remove:function(e){var t=this.visuals.indexOf(e);this.visuals.splice(t,1)},draw:function(){this.drawBackground(),this.drawSpawn(),this.drawHome(),this.drawPath(),this.drawTurrets(),this.showGrid&&this.drawGrid();for(var e=0,t=this.visuals.length;e<t;++e)this.drawVisual(this.visuals[e])},drawBackground:function(){},drawGrid:function(){},drawHome:function(){},drawSpawn:function(){},drawPath:function(){},drawTurrets:function(){},drawVisual:function(e){},playSound:function(){},start:function(){},setGameLogic:function(e){this.logic=e}}),v=(a.CanvasView=g.extend({init:function(e){this._super(e.width,e.height),this.view=e,this.context=e.getContext("2d"),this.sounds={},this.images={},this.nextAnimationFrame=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/h.ticks)}).bind(window)},start:function(){var e=this;e.running=!0;var t=function(){e.running&&e.nextAnimationFrame(t),e.draw()};e.nextAnimationFrame(t)},drawVisual:function(e){var t=this.context,i=e.visual,n=i.index*i.width,s=this.width/this.mazeSize.width,r=this.height/this.mazeSize.height,o=e.mazeCoordinates.x*s,a=e.mazeCoordinates.y*r,h=i.scale*s*Math.min(1,i.width/i.height),u=i.scale*r*Math.min(1,i.height/i.width);o+=.5*(s-h),a+=.5*(r-u),t.drawImage(i.image,n,0,i.width,i.height,o,a,h,u)},drawBackground:function(){var e=this.context;e.clearRect(0,0,this.width,this.height),this.background&&e.drawImage(this.background,0,0,this.width,this.height)},drawHome:function(){var e=this.context,t=this.width/this.mazeSize.width,i=this.height/this.mazeSize.height,n=this.logic.maze.path,s=n[n.length-1].x*t,r=n[n.length-1].y*i;e.fillStyle="rgba(0, 255, 0, 0.7)",e.fillRect(s,r,t,i)},drawSpawn:function(){var e=this.context,t=this.width/this.mazeSize.width,i=this.height/this.mazeSize.height,n=this.logic.maze.path,s=n[0].x*t,r=n[0].y*i;e.fillStyle="rgba(255, 0, 0, 0.7)",e.fillRect(s,r,t,i)},drawGrid:function(){var e=this.context;e.strokeStyle="rgba(0, 0, 0, 0.4)",e.lineWidth=.8;for(var t=1,i=this.mazeSize.width;t<i;++t){var n=t*this.width/i;e.beginPath(),e.moveTo(n,0),e.lineTo(n,this.height),e.stroke(),e.closePath()}for(var s=1,r=this.mazeSize.height;s<r;++s){var o=s*this.height/r;e.beginPath(),e.moveTo(0,o),e.lineTo(this.width,o),e.stroke(),e.closePath()}},drawPath:function(){for(var e=this.context,t=this.width/this.mazeSize.width,i=this.height/this.mazeSize.height,n=this.logic.maze.path,s=0;s<n.length;s++){var r=n[s].x*t,o=n[s].y*i;e.fillStyle="rgba(20, 20, 20, 0.6)",e.fillRect(r,o,t,i)}},drawTurrets:function(){for(var e=this.context,t=this.width/this.mazeSize.width,i=this.height/this.mazeSize.height,n=this.logic.maze.turrets,s=0;s<n.length;s++){var r=n[s].x*t,o=n[s].y*i;e.fillStyle="rgba(20, 20, 200, 0.6)",e.fillRect(r,o,t,i)}},playSound:function(e,t,i){var n=this.sounds[e],s=new v(n,t);isNaN(i)||s.setVolume(i),s.play()},loadImages:function(t,i){var n=0,s=Object.keys(t).length;return Promise.all(e.iterable(t).mapApply(function(e,t){return new Promise(function(r,o){var a=new Image;a.addEventListener("error",function(){o(new Error("Loading image "+e+" ("+t+") failed!"))},!1),a.addEventListener("load",function(){i&&i({name:"images",recent:e,total:s,progress:++n/s}),r([e,a])},!1),a.src=t})}).toArray()).then(function(t){return e.iterable(t).toObject()})},loadSounds:function(t,i){var n=0,s=Object.keys(t).length;return Promise.all(e.iterable(t).mapApply(function(e,t){return new Promise(function(r,o){var a=new Audio;a.addEventListener("error",function(){o(new Error("Loading sound "+e+" ("+t+") failed!"))},!1),a.addEventListener("loadedmetadata",function(){i&&i({name:"sounds",recent:e,total:s,progress:++n/s}),r([e,a])},!1),a.canPlayType("audio/ogg").replace(/^no$/,"")&&t.ogg?a.src=t.ogg:a.canPlayType("audio/mpeg").replace(/^no$/,"")&&t.mp3?a.src=t.mp3:o(new Error("Browser does not support the available audio types!"))})}).toArray()).then(function(t){return e.iterable(t).toObject()})},loadResources:function(e,t,i){var n=this;return console.log("Loading resources..."),n.loadImages(e,i).then(function(e){return console.log("Loaded images..."),n.images=e,n.loadSounds(t,i).then(function(e){console.log("Loaded sounds."),n.sounds=e})})}}),a.Sound=d.extend({init:function(e,t){this.source=e.src,this.loop=!!t,this.setVolume(1)},setVolume:function(e){this.volume=Math.max(0,Math.min(1,e)),this.element&&(this.element.volume=v.volume*this.volume)},play:function(){if(!(this.element||v.active>v.channels)){var e=this;e.element=v.createAudio(this.source),e.setVolume(e.volume);var t=function(){e.loop?(this.currentTime=0,this.play()):(e.element=void 0,this.removeEventListener("ended",t),v.destroyAudio(this))};e.element.addEventListener("ended",t),v.enabled&&e.element.play()}}},function(e){var t=[];e.volume=1,e.channels=6,e.active=0,e.sounds=[],e.enabled=!0,e.createAudio=function(i){var n;e.active++;for(var s=t.length;s--;)if(!(n=t[s]).active&&n.src===i)return n.active=!0,n.element.currentTime=0,n.element;return n={active:!0,src:i,element:new Audio(i)},t.push(n),n.element},e.destroyAudio=function(i){e.active--;for(var n=t.length;n--;)if(t[n].element===i){t[n].active=!1;break}},e.disable=function(){if(e.enabled){e.enabled=!1;for(var i=t.length;i--;)t[i].active&&t[i].element.pause()}},e.enable=function(){if(!e.enabled){e.enabled=!0;for(var i=t.length;i--;)t[i].active&&t[i].element.play()}},e.setVolume=function(i){var n=(i=Math.min(Math.max(i,0),1))/e.volume;e.volume=i;for(var s=t.length;s--;)t[s].element.volume=n*t[s].element.volume}})),w=a.Path=d.extend({init:function(e){this.list=e},propagate:function(e){var t=~~e,i=l.bottom;if(t+1>=this.list.length)return!1;this.list[t].x<this.list[t+1].x?i=l.right:this.list[t].x>this.list[t+1].x?i=l.left:this.list[t].y>this.list[t+1].y&&(i=l.top);var n=this.list[t+1].subtract(this.list[t]);return n=n.scale(e-t),{point:n=this.list[t].add(n),direction:i}}}),y=a.Base=d.extend({init:function(){this.events={}},registerEvent:function(){var e,t,i=arguments.length;for(e=0;e<i;e++)t=arguments[e],this.events[t]||(this.events[t]=[])},unregisterEvent:function(){for(var e=arguments.length,t=0;t<e;t++)delete this.events[arguments[t]]},triggerEvent:function(e,t){if(this.events[e])for(var i=this.events[e],n=i.length;n--;)i[n].apply(this,[t||{}])},addEventListener:function(e,t){this.events[e]&&t&&"function"==typeof t&&this.events[e].push(t)},removeEventListener:function(e,t){if(this.events[e])if(t&&"function"==typeof t){var i=this.events[e].indexOf(t);this.events[e].splice(i,1)}else this.events[e].splice(0,this.events[e].length)}}),z=a.Player=y.extend({init:function(e){this._super(),this.name=e||"Player",this.money=0,this.points=0,this.hitpoints=0,this.registerEvent(u.playerDefeated,u.moneyChanged,u.healthChanged)},setMoney:function(e){this.money=e,this.triggerEvent(u.moneyChanged,this)},addMoney:function(e){this.points+=Math.max(0,e),this.setMoney(this.money+e)},getMoney:function(){return this.money},setHitpoints:function(e){this.hitpoints=Math.max(0,e),this.triggerEvent(u.healthChanged,this),0===this.hitpoints&&this.triggerEvent(u.playerDefeated,this)},addHitpoints:function(e){this.setHitpoints(this.hitpoints+e)},getHitpoints:function(){return this.hitpoints},hit:function(e){this.setHitpoints(this.hitpoints-e.damage)}}),b=a.GameObject=y.extend({init:function(e,t,i){this._super(),this.z=0,this.mazeCoordinates=new p,this.speed=t||0,this.animationDelay=i||15,this.dead=!1,this.direction=l.right,this.logic=e},distanceTo:function(e){return e.subtract(this.mazeCoordinates).norm()},update:function(){var e=this.visual;if(e){var t,i=4===e.frames.length?this.direction:0;if(e.time+=h.ticks,e.direction!==this.direction)for(e.direction=this.direction,e.time=0,e.index=0,t=0;t<i;++t)e.index+=e.frames[t];else if(e.delay<e.time){var n=0;for(e.index++,e.time=0,t=0;t<i;++t)n+=e.frames[t];e.index===n+e.frames[i]&&(e.index=n)}}},getClosestTarget:function(e,t){for(var i,n=Number.MAX_VALUE,s=e.length;s--;){var r=e[s],o=this.distanceTo(r.mazeCoordinates);o<n&&(i=r,n=o)}if(n<=t)return i},playSound:function(e){var t=this.logic&&this.logic.getView();t&&t.playSound(e)},createVisual:function(e,t,i){var n=0,s=0,r=this.logic.getView(),o=r.images&&r.images[e];if(o){for(var a=t.length;a--;)n+=t[a],a<this.direction&&(s+=t[a]);1===t.length&&(s=0),this.visual={direction:this.direction,index:s,time:0,length:n,frames:t,image:o,delay:this.animationDelay,width:o.width/n,height:o.height,scale:i||1}}}}),x=a.Tower=b.extend({init:function(e,t,i,n,s){this._super(e,t,i),this.range=n||0,this.targets=[],this.timeToNextShot=0,this.mazeWeight=0,this.direction=l.left,this.shotType=s||{},this.registerEvent(u.shot)},targetFilter:function(e){return e.strategy!==c.air},update:function(){var e;this._super(this.logic),this.timeToNextShot<=0&&(e=this.shoot()),e?(this.triggerEvent(u.shot,e),this.timeToNextShot=~~(1e3/this.speed)):this.timeToNextShot-=h.ticks},shoot:function(){var e=this.targets.filter(this.targetFilter),t=this.getClosestTarget(e,this.range);if(t){var i=new this.shotType(this.logic);return i.mazeCoordinates=this.mazeCoordinates,i.velocity=t.mazeCoordinates.subtract(this.mazeCoordinates),i.direction=i.velocity.toDirection(),i.targets=e,this.direction=i.direction,i}}}),S=a.Unit=b.extend({init:function(e,t,i,n,s){this._super(e,t,i),this.timer=0,this.path=new w([]),this.mazeCoordinates=new p,this.damage=1,this.strategy=n||c.air,this.hitpoints=s||0,this.health=this.hitpoints,this.direction=l.right,this.registerEvent(u.accomplished,u.died)},playInitSound:function(){this.playSound("humm")},playDeathSound:function(){this.playSound("explosion")},playVictorySound:function(){this.playSound("laugh")},update:function(){this._super(this.logic),this.timer+=h.ticks;var e=.001*this.speed;if(!this.dead&&e>0){var t=this.path.propagate(e*this.timer);t?(this.mazeCoordinates=t.point,this.direction=t.direction):(this.dead=!0,this.triggerEvent(u.accomplished,this),this.playVictorySound())}},hit:function(e){this.health-=e.damage,!this.dead&&this.health<=0&&(this.health=0,this.dead=!0,this.triggerEvent(u.died,this),this.playDeathSound())}}),k=a.Shot=b.extend({init:function(e,t,i,n,s){this._super(e,t,i),this.damage=n||0,this.targets=[],this.impactRadius=s||.5,this.timeToDamagability=~~(200/this.speed),this.velocity=new p,this.registerEvent(u.hit)},update:function(){var e=this.velocity.scale(this.speed*h.ticks*.001);if(this.mazeCoordinates=this.mazeCoordinates.add(e),this._super(this.logic),this.timeToDamagability>0)this.timeToDamagability-=h.ticks;else{var t=this.getClosestTarget(this.targets,this.impactRadius);t&&(t.hit(this),this.dead=!0,this.triggerEvent(u.hit,t))}}}),F=a.GameState={unstarted:0,building:1,waving:2,finished:3},N=a.types={units:{},towers:{},shots:{}},R=a.GameLogic=y.extend({init:function(e,t){var i=this;i._super(),i.towers=[],i.units=[],i.shots=[],i.mediPackCost=h.mediPackCost,i.mediPackFactor=h.mediPackFactor,i.towerBuildCost=h.towerBuildCost,i.towerBuildFactor=h.towerBuildFactor,i.maxTowerNumber=h.towerBuildNumber,i.mediPackHealth=h.mediPackHealth,i.view=e,i.player=new z,i.state=F.unstarted,i.maze=t,i.view.mazeSize=i.getMazeSize(),i.currentWave=null,i.view.setGameLogic(i),i.player.addEventListener(u.playerDefeated,function(e){i.triggerEvent(u.playerDefeated,e),i.finish()}),i.player.addEventListener(u.moneyChanged,function(e){i.triggerEvent(u.moneyChanged,e)}),i.player.addEventListener(u.healthChanged,function(e){i.triggerEvent(u.healthChanged,e)}),i.registerEvent(u.refreshed,u.waveDefeated,u.waveFinished,u.playerDefeated,u.moneyChanged,u.healthChanged,u.waveCreated,u.unitSpawned,u.towerNumberChanged)},start:function(){if(this.state===F.unstarted&&(this.player.setHitpoints(h.hitpoints),this.player.setMoney(h.money),this.triggerEvent(u.towerNumberChanged,{current:this.getNumShooting(),maximum:this.maxTowerNumber}),this.state=F.building),!this.gameLoop){var e=this;this.view.start(),this.gameLoop=setInterval(function(){e.tick()},h.ticks)}},pause:function(){this.gameLoop&&(this.view.pause(),clearInterval(this.gameLoop),this.gameLoop=void 0)},update:function(e){for(var t=e.length;t--;)e[t].update()},tick:function(){if((this.state===F.building||this.state===F.waving)&&(this.update(this.towers),this.state===F.waving)){this.update(this.shots),this.update(this.units),this.removeDeadObjects();for(var e=this.currentWave.update(),t=e.length;t--;){var i=e[t],n=this.maze.getPath();i.mazeCoordinates=this.maze.start,i.path=new w(n),this.addUnit(i)}}},finish:function(){this.state=F.finished},getViewSize:function(){return this.view.getSize()},getNumShooting:function(){return this.towers.length},getMazeSize:function(){return this.maze.gridDim},transformCoordinates:function(e,t){var i=e*this.maze.gridDim.width/this.view.width,n=t*this.maze.gridDim.height/this.view.height;return new p(~~i,~~n)},removeTower:function(e){e.removeEventListener(u.shot),this.towers.splice(this.towers.indexOf(e),1),this.view.remove(e)},addTower:function(e){var t=this;e.addEventListener(u.shot,function(e){t.addShot(e)}),t.towers.push(e),t.view.add(e)},addShot:function(e){this.shots.push(e),this.view.add(e),e.playInitSound()},addUnit:function(e){var t=this;e.addEventListener(u.accomplished,function(e){t.player.hit(e)}),e.playInitSound(),t.units.push(e),t.view.add(e)},removeDead:function(e){for(var t=e.length;t--;)e[t].dead&&(this.view.remove(e[t]),e.splice(t,1))},removeDeadObjects:function(){this.removeDead(this.towers),this.removeDead(this.shots),this.removeDead(this.units),this.currentWave.finished&&0===this.units.length&&this.endWave()},endWave:function(){this.player.addMoney(this.currentWave.prizeMoney),this.state=F.building;for(var e=this.shots.length;e--;)this.view.remove(this.shots[e]),this.shots.splice(e,1);this.triggerEvent(u.waveDefeated,this.player)},beginWave:function(){if(this.state===F.building){var e=this;e.state=F.waving;var t=e.waves.next();t.addEventListener(u.waveFinished,function(){e.triggerEvent(u.waveFinished),t.removeEventListener(u.waveFinished),t.removeEventListener(u.unitSpawned)}),t.addEventListener(u.unitSpawned,function(t){e.triggerEvent(u.unitSpawned,t)}),e.triggerEvent(u.waveCreated,t),e.currentWave=t}},buildTower:function(e,t){var i=new t(this),n=this.getNumShooting();return!!(this.state===F.building&&t.cost<=this.player.money&&n<this.maxTowerNumber&&(i.mazeCoordinates=e,i.cost=t.cost,i.targets=this.units,this.maze.tryBuild(e,i.mazeWeight)))&&(this.player.addMoney(-t.cost),this.addTower(i),this.triggerEvent(u.towerNumberChanged,{current:n+1,maximum:this.maxTowerNumber}),!0)},destroyTower:function(e){if(this.state==F.building){var t=this.towers.filter(function(t){return t.mazeCoordinates.x===e.x&&t.mazeCoordinates.y===e.y})[0];t&&(this.player.addMoney(.5*t.cost),this.removeTower(t),this.maze.tryRemove(e),this.triggerEvent(u.towerNumberChanged,{current:this.getNumShooting(),maximum:this.maxTowerNumber}))}},getView:function(){return this.view},setWaves:function(e){var t=this;return this.waves=e,e&&e.waves.forEach(function(e){e.logic=t}),this}}),W=a.WaveList=d.extend({init:function(e){this.waves=e,this.index=0,this.unitNames=Object.keys(N.units)},next:function(){if(this.index<this.waves.length)return this.waves[this.index++]},setGameLogic:function(e){this.logic=e}}),D=a.Wave=y.extend({init:function(e,t,i){this._super(),this.startTime=0,this.units=i||[],this.prizeMoney=t||0,this.finished=!1,this.registerEvent(u.unitSpawned,u.waveFinished),this.logic=e},add:function(e,t){this.units.push({time:t,unit:e})},update:function(){var e=[];if(!this.finished){for(var t=this.units.length;t--;)this.units[t].time<this.startTime&&(e.push(new N.units[this.units[t].unit](this.logic)),this.units.splice(t,1));if(0===this.units.length&&(this.finished=!0,this.triggerEvent(u.waveFinished)),e.length>0){var i=this.units.length;this.triggerEvent(u.unitSpawned,i)}this.startTime+=h.ticks}return e}}),T=a.Mario=S.extend({init:function(e){this._super(e,T.speed,100,c.manhattan,T.hitpoints),this.createVisual(T.sprite,[8,8,8,8])}},function(e){e.speed=2,e.hitpoints=10,e.description="You have to be careful with that plumber.",e.nickName="Mario",e.sprite="mario",N.units.Mario=e}),_=a.Rope=S.extend({init:function(e){this._super(e,_.speed,80,c.euclideanNoSQR,_.hitpoints),this.createVisual(_.sprite,[4,4,4,4],.8)}},function(e){e.speed=2,e.hitpoints=20,e.description="An ugly rope that tries to conquer the zone. Watch out when they mass up!",e.nickName="Rope",e.sprite="rope",N.units.Rope=e}),M=a.FireWizzrobe=S.extend({init:function(e){this._super(e,M.speed,70,c.manhattan,M.hitpoints),this.createVisual(M.sprite,[3,3,3,3],1.4)}},function(e){e.speed=3,e.hitpoints=30,e.description="The wizard with the fire robe is quite fast, but does not take very much.",e.nickName="Wizzrobe",e.sprite="firewizzrobe",N.units.FireWizzrobe=e}),C=a.AirWolf=S.extend({init:function(e){this._super(e,C.speed,50,c.air,C.hitpoints),this.createVisual(C.sprite,[4])}},function(e){e.speed=2,e.hitpoints=40,e.description="The air wolf is the only aerial unit in the game. Do not underestimate him as an air wolf fleet could kill you.",e.nickName="Wolf",e.sprite="airwolf",N.units.AirWolf=e}),E=a.DarkNut=S.extend({init:function(e){this._super(e,E.speed,80,c.euclideanNoSQR,E.hitpoints),this.createVisual(E.sprite,[4,4,4,4])}},function(e){e.speed=2.5,e.hitpoints=150,e.description="The dark nut is an ancient warrier that takes quite some hits. His speed is superior to most other units.",e.nickName="Dark Nut",e.sprite="darknut",N.units.DarkNut=e}),P=a.Speedy=S.extend({init:function(e){this._super(e,P.speed,25,c.diagonalShortCut,P.hitpoints),this.createVisual(P.sprite,[20])}},function(e){e.speed=5.2,e.hitpoints=200,e.description="This unit is just a single blob. It is ultra fast and has quite some armor. It will give you some trouble.",e.nickName="HAL",e.sprite="newunit",N.units.Speedy=e}),A=a.Armos=S.extend({init:function(e){this._super(e,A.speed,125,c.euclidean,A.hitpoints),this.createVisual(A.sprite,[4,4,4,4],1.2)}},function(e){e.speed=1,e.hitpoints=600,e.description="The unit is actually called Armos and not Armor, however, Armor would have been a good name as well. You will need some fire power to bring him down.",e.nickName="Armos",e.sprite="armos",N.units.Armos=e}),L=a.StandardShot=k.extend({init:function(e){this._super(e,L.speed,15,L.damage,L.impactRadius),this.createVisual(L.sprite,[1],.25)},playInitSound:function(){this.playSound("wowpulse")}},function(e){e.nickName="Standard",e.description="Just an ordinary shot with no special ability.",e.sprite="sunshot",e.frames=1,e.speed=10,e.damage=1,e.impactRadius=.5,N.shots.StandardShot=e}),V=a.AirShot=k.extend({init:function(e){this._super(e,V.speed,10,V.damage,V.impactRadius),this.createVisual(V.sprite,[1,1,1,1],.2)},playInitSound:function(){this.playSound("flak")}},function(e){e.nickName="SAM",e.description="Surface to air missile that is highly effective.",e.sprite="airshot",e.frames=4,e.speed=2.5,e.damage=5,e.impactRadius=.5,N.shots.AirShot=e}),I=a.FlameShot=k.extend({init:function(e){this._super(e,I.speed,100,I.damage,I.impactRadius),this.createVisual(I.sprite,[8])},playInitSound:function(){this.playSound("flames")}},function(e){e.nickName="Red Napalm",e.description="Napalm power you don't want to mess with.",e.sprite="flameshot",e.frames=8,e.speed=1.5,e.damage=8,e.impactRadius=.5,N.shots.FlameShot=e}),H=a.HellShot=k.extend({init:function(e){this._super(e,H.speed,75,H.damage,H.impactRadius),this.createVisual(H.sprite,[12])},playInitSound:function(){this.playSound("hellshot")}},function(e){e.nickName="HDEB",e.description="The High Dark Energy Density is shot by the gate to hell. It catches your soul and gives you the rest.",e.sprite="hellshot",e.frames=12,e.speed=2,e.damage=300,e.impactRadius=.5,N.shots.HellShot=e}),G=a.IceShot=k.extend({init:function(e){this._super(e,G.speed,200,G.damage,G.impactRadius),this.createVisual(G.sprite,[4])},playInitSound:function(){this.playSound("icy")}},function(e){e.nickName="Snowball 5",e.description="An experimental super cold plasma (cold is relative here).",e.sprite="iceshot",e.frames=4,e.speed=3.5,e.damage=15,e.impactRadius=.5,N.shots.IceShot=e}),j=a.MGShot=k.extend({init:function(e){this._super(e,j.speed,25,j.damage,j.impactRadius),this.createVisual(j.sprite,[1,1,1,1],.3)},playInitSound:function(){this.playSound("mgnest")}},function(e){e.nickName="Nato cal. 7.72",e.description="Standard MG shot: 7.72 mm full metal jacket that handles most guys.",e.sprite="mgshot",e.frames=4,e.speed=8,e.damage=2,e.impactRadius=.5,N.shots.MGShot=e}),B=a.LaserShot=k.extend({init:function(e){this._super(e,B.speed,25,B.damage,B.impactRadius),this.createVisual(B.sprite,[6,6,6,6])},playInitSound:function(){this.playSound("laser")}},function(e){e.nickName="Faser",e.description="Neutrino shot: Hits before fired (from the perspective of any observer).",e.sprite="lasershot",e.frames=24,e.speed=10,e.damage=7,e.impactRadius=.5,N.shots.LaserShot=e}),q=a.ShellShot=k.extend({init:function(e){this._super(e,q.speed,25,q.damage,q.impactRadius),this.createVisual(q.sprite,[1,1,1,1],.3)},playInitSound:function(){this.playSound("artillery")}},function(e){e.nickName="Shell",e.description="Hardened steel projectile that is no joke.",e.sprite="shellshot",e.frames=4,e.speed=16,e.damage=15,e.impactRadius=.5,N.shots.ShellShot=e}),O=a.MGNest=x.extend({init:function(e){this._super(e,O.speed,25,O.range,O.shotType),this.createVisual(O.sprite,[1])}},function(e){e.description="The MG Nest is cheap but powerful. It can help you a lot against low armored units.",e.nickName="MG Nest",e.sprite="mgnest",e.frames=1,e.shotType=j,e.speed=4,e.range=3,e.cost=7,N.towers.MGNest=e}),U=a.CanonTower=x.extend({init:function(e){this._super(e,U.speed,50,U.range,U.shotType),this.createVisual(U.sprite,[1,1,1,1])}},function(e){e.description="The backbone in war! It has an amazing range and shoots shells, however, the firing speed could be better.",e.nickName="Canon",e.sprite="canontower",e.frames=4,e.shotType=q,e.speed=1,e.range=8,e.cost=12,N.towers.CanonTower=e}),Q=a.FlameTower=x.extend({init:function(e){this._super(e,Q.speed,200,Q.range,Q.shotType),this.createVisual(Q.sprite,[4])}},function(e){e.description="Burn them down but a bit faster ... Excellent for slow armored units, but fails against strong armored enemies.",e.nickName="Flame tower",e.sprite="flametower",e.frames=4,e.shotType=I,e.speed=6,e.range=2,e.cost=15,N.towers.FlameTower=e}),Y=a.IceTower=x.extend({init:function(e){this._super(e,Y.speed,200,Y.range,Y.shotType),this.createVisual(Y.sprite,[1,1,1,1])}},function(e){e.description="Cool. Slow shots, but with high efficiency. The right choice against slow strongly armored units.",e.nickName="Ice-Tower",e.sprite="icetower",e.frames=4,e.shotType=G,e.speed=2,e.range=6,e.cost=25,N.towers.IceTower=e}),X=a.LaserTower=x.extend({init:function(e){this._super(e,X.speed,25,X.range,X.shotType),this.createVisual(X.sprite,[1,1,1,1])}},function(e){e.description="Won't play with you, but does it with high efficiency. Really fast low damage shots.",e.nickName="Faser",e.sprite="lasertower",e.frames=4,e.shotType=B,e.speed=3,e.range=5,e.cost=29,N.towers.LaserTower=e}),$=a.GateToHell=x.extend({init:function(e){this._super(e,$.speed,200,$.range,$.shotType),this.createVisual($.sprite,[6])}},function(e){e.description="Paint rules! This is the ultimate weapon of war, but it will not kill high speed units.",e.nickName="Hellgate",e.sprite="gatetohell",e.frames=6,e.shotType=H,e.speed=1,e.range=2,e.cost=55,N.towers.GateToHell=e}),J=a.TowerDefense=o({"static Definition":o({constructor:function(t){e.initialize(this,t).string("gameId",{ignore:!0}).integer("mapHeight",{ignore:!0}).integer("mapWidth",{ignore:!0}).array("creepPath",{ignore:!0}).array("towerPlaces",{ignore:!0}).array("waves",{ignore:!0}).integer("startMoney",{defaultValue:10,coerce:!0}).integer("startHP",{defaultValue:1,coerce:!0})},__maze__:function(){var e=function(e){return new p(e[0],e[1])};return new f(new m(this.mapWidth,this.mapHeight),this.creepPath.map(e),this.towerPlaces.map(e))},__waveList__:function(){return new W(this.waves.map(function(e){return new D(null,e[0],e[1].map(function(e){return{time:e[0],unit:e[1]}}))}))},game:function(t){return new J(e.copy(t||{},{def:this}))}}),constructor:function(t){e.initialize(this,t).object("def").integer("money",{defaultValue:this.def.startMoney,coerce:!0}).integer("hp",{defaultValue:this.def.startHP,coerce:!0}).integer("level",{defaultValue:0,coerce:!0}).array("towers",{ignore:!0}),this.towers||(this.towers=e.Iterable.repeat(null,this.def.towerPlaces.length).toArray())},result:function(){return this.hp<=0?this.level-this.def.waves.length-1:this.level>=this.def.waves.length?this.hp+this.money/h.mediPackCost:null},__logic__:function(e){e=e||new g(0,0);var t=this.def.__maze__(),i=this.def.__waveList__(),n=new R(e,t);return n.gameId=this.def.gameId,n.state=F.building,n.player.money=999,this.towers.forEach(function(e,i){e&&n.buildTower(t.turrets[i],e)}),n.player.money=this.money,n.player.hitpoints=this.hp,i.index=this.level,n.setWaves(i),n},fromGameLogic:function(t){var i=e.iterable(t.towers).map(function(e){var t=e.mazeCoordinates;return[t.x+","+t.y,e]}).toObject();return new this.constructor({def:this.def,money:t.player.money,hp:t.player.hitpoints,level:t.waves.index,towers:t.maze.turrets.map(function(e){var t=i[e.x+","+e.y];return t?t.constructor:null})})},next:function(t){for(var i=this,n=this.__logic__(),s=0;s<t.length;s++)t[s]!==this.towers[s]&&this.towers[s]&&n.destroyTower(n.maze.turrets[s]);for(s=0;s<t.length;s++)t[s]&&t[s]!==this.towers[s]&&t[s].cost<=n.player.money&&n.buildTower(n.maze.turrets[s],t[s]);var r=new e.Future;return n.addEventListener(u.playerDefeated,function(){r.resolve(n)}),n.addEventListener(u.waveDefeated,function(){r.resolve(n)}),n.start(),n.beginWave(),r.then(function(e){return e.pause(),i.fromGameLogic(e)})},toString:function(){return"TowerDefense("+this.money+","+this.hp+","+this.level+",["+this.towers.map(function(e){return e?e.nickName:""}).join(",")+"])"}});a.AIPlayer=o({constructor:function(e){e=e||{},this.name=e.name||"AIPlayer",this.size=+e.size||10,this.steps=+e.steps||10,this.expansionRate=+e.expansionRate||.5,this.mutationRate=+e.mutationRate||.25},Problem:o(i.Problem,{constructor:function(t){t.objectives=1/0,i.Problem.call(this,t),this.game=t.game,this.towerTypes=e.iterable(N.towers).select(1).toArray();var n={min:0,max:this.towerTypes.length+1,discrete:!0};this.__elementModel__=e.Iterable.repeat(n,this.game.def.towerPlaces.length).toArray()},mapping:function(e){var t=this;return e.values.map(function(e){return t.towerTypes[e]||null})},emblem:function(e){return"["+this.mapping(e).map(function(e){return e?e.nickName:""}).join("|")+"]"},evaluation:function(e){var t=this.mapping(e);return this.game.next(t).then(function(e){return e.hp+e.money/h.mediPackCost})}}),decision:function(e){var t=new this.Problem({game:e}),n=new i.metaheuristics.GeneticAlgorithm({problem:t,size:this.size,steps:this.steps,expansionRate:this.expansionRate,mutationRate:this.mutationRate});return n.events.on("advanced",function(){for(n.nub();n.state.length<n.size;)n.state.push(t.newElement())}),n.run().then(function(e){return e.mapping()})},play:function(t,i){var n=this;return e.Future.doWhile(function(e){return e=e||t,n.decision(e).then(function(t){return e.next(t).then(function(n){return i&&i(e,t,n),n})})},function(e){return!e.result()})}}),a.scenarios={Test01:new J.Definition({gameId:"Test01",mapWidth:8,mapHeight:8,creepPath:[[1,0],[1,1],[1,2],[1,3],[1,4],[2,4],[3,4],[3,5],[3,6],[4,6],[5,6],[5,5],[5,4],[5,3],[5,2],[5,1],[5,0]],towerPlaces:[[2,3],[4,5],[4,3],[2,1],[2,5]],waves:[[10,[[1,"Mario"],[400,"Mario"],[1e3,"Rope"],[1200,"Rope"]]],[12,[[1,"Mario"],[350,"Rope"],[850,"Mario"],[1100,"Mario"],[1800,"Rope"],[2500,"Rope"]]],[16,[[1,"Mario"],[350,"Rope"],[500,"FireWizzrobe"],[1e3,"Rope"],[1500,"FireWizzrobe"]]],[20,[[1,"Speedy"],[200,"FireWizzrobe"],[500,"Rope"],[600,"FireWizzrobe"],[900,"FireWizzrobe"],[1300,"FireWizzrobe"],[2800,"DarkNut"]]],[22,[[1,"FireWizzrobe"],[600,"Rope"],[1500,"FireWizzrobe"],[2e3,"Rope"],[2800,"FireWizzrobe"],[3700,"DarkNut"],[4500,"DarkNut"],[6e3,"FireWizzrobe"]]],[25,[[1,"DarkNut"],[500,"FireWizzrobe"],[1e3,"FireWizzrobe"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"]]],[25,[[1,"DarkNut"],[600,"FireWizzrobe"],[1e3,"DarkNut"],[2200,"Rope"],[2500,"Rope"],[2600,"Rope"],[4e3,"FireWizzrobe"],[4900,"FireWizzrobe"],[6e3,"Armos"]]],[30,[[1,"DarkNut"],[1e3,"DarkNut"],[2200,"FireWizzrobe"],[2800,"FireWizzrobe"],[4e3,"Armos"],[5e3,"DarkNut"],[5400,"FireWizzrobe"],[6e3,"FireWizzrobe"]]]],startMoney:25,startHP:10}),Test02:new J.Definition({gameId:"Test02",mapWidth:8,mapHeight:8,creepPath:[[0,4],[1,4],[2,4],[2,5],[2,6],[3,6],[4,6],[4,5],[4,4],[4,3],[4,2],[5,2],[6,2],[7,2]],towerPlaces:[[3,4],[1,5],[5,3]],waves:[[10,[[1,"Mario"],[400,"Mario"],[1e3,"Rope"],[1200,"Rope"]]],[12,[[1,"Mario"],[350,"Rope"],[850,"Mario"],[1100,"Mario"],[1800,"Rope"],[2500,"Rope"]]],[16,[[1,"Mario"],[350,"Rope"],[500,"FireWizzrobe"],[800,"FireWizzrobe"],[1e3,"Rope"],[1500,"FireWizzrobe"]]],[20,[[1,"Speedy"],[200,"FireWizzrobe"],[500,"Rope"],[550,"Rope"],[600,"FireWizzrobe"],[680,"Rope"],[900,"FireWizzrobe"],[1300,"FireWizzrobe"],[2800,"DarkNut"]]],[22,[[1,"FireWizzrobe"],[500,"Rope"],[550,"Rope"],[1e3,"FireWizzrobe"],[1200,"Rope"],[1350,"Rope"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"],[4200,"FireWizzrobe"]]],[25,[[1,"DarkNut"],[500,"FireWizzrobe"],[1e3,"FireWizzrobe"],[1200,"DarkNut"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"],[4200,"DarkNut"]]],[20,[[1,"DarkNut"],[250,"FireWizzrobe"],[600,"FireWizzrobe"],[1e3,"DarkNut"],[2200,"Rope"],[2300,"Rope"],[2400,"Rope"],[2500,"Rope"],[2600,"Rope"],[4e3,"FireWizzrobe"],[4200,"DarkNut"],[4400,"FireWizzrobe"],[6e3,"Armos"]]],[25,[[1,"DarkNut"],[250,"DarkNut"],[600,"DarkNut"],[1e3,"DarkNut"],[2200,"FireWizzrobe"],[2300,"FireWizzrobe"],[2400,"Rope"],[2500,"Rope"],[2600,"FireWizzrobe"],[4e3,"Armos"],[5e3,"DarkNut"],[5400,"FireWizzrobe"],[6e3,"FireWizzrobe"],[8e3,"Armos"]]]],startMoney:15,startHP:10}),Test03:new J.Definition({gameId:"Test03",mapWidth:8,mapHeight:8,creepPath:[[0,4],[1,4],[2,4],[3,4],[4,4],[4,3],[4,2],[5,2],[6,2],[7,2]],towerPlaces:[[2,3],[4,5],[5,3],[2,5]],waves:[[8,[[1,"Mario"],[700,"Mario"],[1800,"Rope"],[2800,"Rope"],[4e3,"DarkNut"]]],[8,[[1,"Mario"],[350,"Mario"],[700,"Mario"],[1800,"Rope"],[2300,"Rope"],[2800,"Rope"],[3800,"FireWizzrobe"],[5e3,"DarkNut"]]],[9,[[1,"Mario"],[350,"Rope"],[400,"Mario"],[600,"Rope"],[800,"Rope"],[1e3,"Rope"],[1500,"FireWizzrobe"]]],[12,[[1,"FireWizzrobe"],[450,"Rope"],[600,"FireWizzrobe"],[900,"FireWizzrobe"],[1200,"FireWizzrobe"]]],[15,[[1,"FireWizzrobe"],[500,"Rope"],[550,"Rope"],[600,"Rope"],[650,"Rope"],[700,"Rope"],[1600,"FireWizzrobe"],[4e3,"FireWizzrobe"],[4200,"FireWizzrobe"]]],[20,[[1,"DarkNut"],[500,"FireWizzrobe"],[1e3,"FireWizzrobe"],[1200,"DarkNut"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"],[4200,"DarkNut"]]],[20,[[1,"DarkNut"],[250,"FireWizzrobe"],[600,"FireWizzrobe"],[1e3,"DarkNut"],[2200,"Rope"],[2300,"Rope"],[2400,"Rope"],[2500,"Rope"],[2600,"Rope"],[4e3,"FireWizzrobe"],[4200,"DarkNut"],[4400,"FireWizzrobe"],[6e3,"Armos"]]],[25,[[1,"DarkNut"],[250,"DarkNut"],[600,"DarkNut"],[1e3,"DarkNut"],[2200,"FireWizzrobe"],[2300,"FireWizzrobe"],[2400,"Rope"],[2500,"Rope"],[2600,"FireWizzrobe"],[4e3,"Armos"],[5e3,"DarkNut"],[5400,"FireWizzrobe"],[6e3,"FireWizzrobe"],[8e3,"Armos"]]]],startMoney:14,startHP:10})};return a});
//# sourceMappingURL=ludorum-towerdefense.min.js.map