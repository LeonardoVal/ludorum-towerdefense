//! ludorum-towerdefense 0.0.1

(function(a){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","inveniemus"],a):"object"==typeof exports&&module.exports?module.exports=a(require("creatartis-base"),require("sermat"),require("inveniemus")):this["ludorum-towerdefense"]=a(this.base,this.Sermat,this.inveniemus)}).call(this,function(a,b,c){"use strict";var d=a.declare,e={},f=e.constants={ticks:25,money:99,hitpoints:10,mediPackCost:20,mediPackFactor:1,mediPackHealth:1,towerBuildCost:5,towerBuildFactor:1,towerBuildNumber:10},g=e.events={click:"click",mousemove:"mousemove",mouseover:"mouseover",mouseout:"mouseout",contextmenu:"contextmenu",died:"died",shot:"shot",hit:"hit",accomplished:"accomplished",playerDefeated:"playerDefeated",moneyChanged:"moneyChanged",waveCreated:"waveCreated",waveFinished:"waveFinished",waveDefeated:"waveDefeated",healthChanged:"healthChanged",unitSpawned:"unitSpawned",towerNumberChanged:"towerNumberChanged"},h=e.Class=function(){var a=!1,b=/\b_super\b/,c=function(){};return c.extend=function(c,d){var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];var h=function(){!a&&this.init&&this.init.apply(this,arguments)};return h.prototype=f,h.prototype.constructor=h,h.extend=this.extend,d&&"function"==typeof d&&d(h),h},c}(),i=e.MazeStrategy={manhattan:1,maxDXDY:2,diagonalShortCut:3,euclidean:4,euclideanNoSQR:5,custom:6,air:7},j=e.Direction={right:0,top:1,left:2,bottom:3},k=(e.Steps={WithDiagonals:[[0,-1],[1,0],[0,1],[-1,0],[1,-1],[1,1],[-1,1],[-1,-1]],OnlyStraight:[[0,-1],[1,0],[0,1],[-1,0]]},e.Point=h.extend({init:function(a,b){this.x=a||0,this.y=b||0},clone:function(){return new k(this.x,this.y)},add:function(a){return new k(this.x+a.x,this.y+a.y)},subtract:function(a){return new k(this.x-a.x,this.y-a.y)},projectOn:function(a){return this.x*a.x+this.y*a.y},norm:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},square:function(){return this.x*this.x+this.y*this.y},scale:function(a){return new k(this.x*a,this.y*a)},normalize:function(){var a=1/this.norm();return this.scale(a)},regularize:function(){return 0===this.x&&0===this.y?new k(2*Math.round(Math.random())-1,2*Math.round(Math.random())-1):this},toDirection:function(){return this.x>this.y?this.x>-this.y?j.right:j.top:this.x>-this.y?j.bottom:j.left}})),l=e.Size=h.extend({init:function(a,b){this.width=a||0,this.height=b||0},clone:function(){return new l(this.width,this.height)},divide:function(a){return new l(this.width/a.width,this.height/a.height)}}),m=e.Maze=h.extend({init:function(a,b,c){this.gridDim=a;for(var d=[],e=0;e<a.width+1;e++){for(var f=[],g=0;g<a.height;g++)f.push(1);d.push(f)}this.grid=d,this.path=b,this.start=b[0],this.end=b[b.length-1],this.paths={},this.turrets=c},tryBuild:function(a,b){if(1!==this.grid[a.x][a.y])return!1;for(var c=0;c<this.turrets.length;c++)if(this.turrets[c].x==a.x&&this.turrets[c].y==a.y)return this.grid[a.x][a.y]=b||0,!0;return!1},tryRemove:function(a){return 1!==this.grid[a.x][a.y]&&(this.grid[a.x][a.y]=1,this.paths={},!0)},getPath:function(){return this.path}}),n=e.ResourceLoader=h.extend({init:function(a){this.keys=a||{},this.loaded=0,this.loading=0,this.errors=0,this.finished=!1,this.oncompleted=void 0,this.onprogress=void 0,this.onerror=void 0},completed:function(){this.finished=!0,this.oncompleted&&"function"==typeof this.oncompleted&&this.oncompleted.apply(this,[{loaded:this.loaded}])},progress:function(a){this.loading--,this.loaded++;var b=this.loaded+this.loading+this.errors;this.onprogress&&"function"==typeof this.onprogress&&this.onprogress.apply(this,[{recent:a,total:b,progress:this.loaded/b}]),0===this.loading&&this.completed()},error:function(a){this.loading--,this.errors++;var b=this.loaded+this.loading+this.errors;this.onerror&&"function"==typeof this.onerror&&this.onerror.apply(this,[{error:a,total:b,progress:this.loaded/b}])},load:function(a,b,c,d){b&&"function"==typeof b&&(this.oncompleted=b),c&&"function"==typeof c&&(this.onprogress=c),d&&"function"==typeof d&&(this.onerror=d);for(var e=a.length;e--;){var f=a[e];this.loadResource(f.name,f.value)}},loadResource:function(a,b){this.loading++,this.keys[a]=b}}),o=e.ImageLoader=n.extend({init:function(a){this._super(a)},loadResource:function(a,b){var c=this,d=new Image;d.addEventListener("error",function(){c.error(a)},!1),d.addEventListener("load",function(){c.progress(a)},!1),d.src=b,this._super(a,d)}}),p=e.SoundLoader=n.extend({init:function(a){this._super(a)},loadResource:function(a,b){var c=this,d=new Audio;d.addEventListener("loadedmetadata",function(){c.progress(a)},!1),d.addEventListener("error",function(){c.error(a)},!1),d.canPlayType("audio/ogg").replace(/^no$/,"")?d.src=b.ogg:d.canPlayType("audio/mpeg").replace(/^no$/,"")?d.src=b.mp3:c.progress(a),this._super(a,d)}}),q=e.Loader=h.extend({init:function(a,b,c){this.completed=a||function(){},this.progress=b||function(){},this.error=c||function(){},this.sets=[]},set:function(a,b,c,d){this.sets.push({name:a,resources:d,loader:new b(c)})},start:function(){this.next()},next:function(){var a=this,b=a.sets.pop(),c=function(b){a.next()},d=function(c){c.name=b.name,a.progress(c)},e=function(c){c.name=b.name,a.error(c)};return b?(a.progress({name:b.name,recent:"",total:b.resources.length,progress:0}),void b.loader.load(b.resources,c,d,e)):void a.completed()}}),r=e.View=h.extend({init:function(a,b){this.running=!1,this.visuals=[],this.background=void 0,this.width=a,this.height=b,this.showGrid=!0,this.mazeSize=new l(25,25)},pause:function(){this.running=!1},add:function(a){if(Array.isArray(a))for(var b=0,c=a.length;b<c;++b)this.visuals.push(a[b]);else this.visuals.push(a);this.visuals.sort(function(a,b){return a.z-b.z})},remove:function(a){var b=this.visuals.indexOf(a);this.visuals.splice(b,1)},draw:function(){this.drawBackground(),this.drawSpawn(),this.drawHome(),this.drawPath(),this.drawTurrets(),this.showGrid&&this.drawGrid();for(var a=0,b=this.visuals.length;a<b;++a)this.drawVisual(this.visuals[a])},drawBackground:function(){},drawGrid:function(){},drawHome:function(){},drawSpawn:function(){},drawPath:function(){},drawTurrets:function(){},drawVisual:function(a){},playSound:function(){},start:function(){},setGameLogic:function(a){this.logic=a}}),s=(e.CanvasView=r.extend({init:function(a){this._super(a.width,a.height),this.view=a,this.context=a.getContext("2d"),this.sounds={},this.images={},this.nextAnimationFrame=(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/f.ticks)}).bind(window)},start:function(){var a=this;a.running=!0;var b=function(){a.running&&a.nextAnimationFrame(b),a.draw()};a.nextAnimationFrame(b)},drawVisual:function(a){var b=this.context,c=a.visual,d=c.index*c.width,e=0,f=this.width/this.mazeSize.width,g=this.height/this.mazeSize.height,h=a.mazeCoordinates.x*f,i=a.mazeCoordinates.y*g,j=c.scale*f*Math.min(1,c.width/c.height),k=c.scale*g*Math.min(1,c.height/c.width);h+=.5*(f-j),i+=.5*(g-k),b.drawImage(c.image,d,e,c.width,c.height,h,i,j,k)},drawBackground:function(){var a=this.context;a.clearRect(0,0,this.width,this.height),this.background&&a.drawImage(this.background,0,0,this.width,this.height)},drawHome:function(){var a=this.context,b=this.width/this.mazeSize.width,c=this.height/this.mazeSize.height,d=this.logic.maze.path,e=d[d.length-1].x*b,f=d[d.length-1].y*c;a.fillStyle="rgba(0, 255, 0, 0.7)",a.fillRect(e,f,b,c)},drawSpawn:function(){var a=this.context,b=this.width/this.mazeSize.width,c=this.height/this.mazeSize.height,d=this.logic.maze.path,e=d[0].x*b,f=d[0].y*c;a.fillStyle="rgba(255, 0, 0, 0.7)",a.fillRect(e,f,b,c)},drawGrid:function(){var a=this.context;a.strokeStyle="rgba(0, 0, 0, 0.4)",a.lineWidth=.8;for(var b=1,c=this.mazeSize.width;b<c;++b){var d=b*this.width/c;a.beginPath(),a.moveTo(d,0),a.lineTo(d,this.height),a.stroke(),a.closePath()}for(var e=1,f=this.mazeSize.height;e<f;++e){var g=e*this.height/f;a.beginPath(),a.moveTo(0,g),a.lineTo(this.width,g),a.stroke(),a.closePath()}},drawPath:function(){for(var a=this.context,b=this.width/this.mazeSize.width,c=this.height/this.mazeSize.height,d=this.logic.maze.path,e=0;e<d.length;e++){var f=d[e].x*b,g=d[e].y*c;a.fillStyle="rgba(20, 20, 20, 0.6)",a.fillRect(f,g,b,c)}},drawTurrets:function(){for(var a=this.context,b=this.width/this.mazeSize.width,c=this.height/this.mazeSize.height,d=this.logic.maze.turrets,e=0;e<d.length;e++){var f=d[e].x*b,g=d[e].y*c;a.fillStyle="rgba(20, 20, 200, 0.6)",a.fillRect(f,g,b,c)}},playSound:function(a,b,c){var d=this.sounds[a],e=new s(d,b);isNaN(c)||e.setVolume(c),e.play()},loadResources:function(a,b,c){var d=new q(b,c);d.set("Images",o,this.images,a.images),d.set("Sounds",p,this.sounds,a.sounds),d.start()}}),e.Sound=h.extend({init:function(a,b){this.source=a.src,this.loop=!!b,this.setVolume(1)},setVolume:function(a){this.volume=Math.max(0,Math.min(1,a)),this.element&&(this.element.volume=s.volume*this.volume)},play:function(){if(!(this.element||s.active>s.channels)){var a=this;a.element=s.createAudio(this.source),a.setVolume(a.volume);var b=function(){a.loop?(this.currentTime=0,this.play()):(a.element=void 0,this.removeEventListener("ended",b),s.destroyAudio(this))};a.element.addEventListener("ended",b),s.enabled&&a.element.play()}}},function(a){var b=[];a.volume=1,a.channels=6,a.active=0,a.sounds=[],a.enabled=!0,a.createAudio=function(c){var d;a.active++;for(var e=b.length;e--;)if(d=b[e],!d.active&&d.src===c)return d.active=!0,d.element.currentTime=0,d.element;return d={active:!0,src:c,element:new Audio(c)},b.push(d),d.element},a.destroyAudio=function(c){a.active--;for(var d=b.length;d--;)if(b[d].element===c){b[d].active=!1;break}},a.disable=function(){if(a.enabled){a.enabled=!1;for(var c=b.length;c--;)b[c].active&&b[c].element.pause()}},a.enable=function(){if(!a.enabled){a.enabled=!0;for(var c=b.length;c--;)b[c].active&&b[c].element.play()}},a.setVolume=function(c){c=Math.min(Math.max(c,0),1);var d=c/a.volume;a.volume=c;for(var e=b.length;e--;)b[e].element.volume=d*b[e].element.volume}})),t=e.Path=h.extend({init:function(a){this.list=a},propagate:function(a){var b=~~a,c=j.bottom;if(b+1>=this.list.length)return!1;this.list[b].x<this.list[b+1].x?c=j.right:this.list[b].x>this.list[b+1].x?c=j.left:this.list[b].y>this.list[b+1].y&&(c=j.top);var d=this.list[b+1].subtract(this.list[b]);return d=d.scale(a-b),d=this.list[b].add(d),{point:d,direction:c}}}),u=e.Base=h.extend({init:function(){this.events={}},registerEvent:function(){var a,b,c=arguments.length;for(a=0;a<c;a++)b=arguments[a],this.events[b]||(this.events[b]=[])},unregisterEvent:function(){for(var a=arguments.length,b=0;b<a;b++)delete this.events[arguments[b]]},triggerEvent:function(a,b){if(this.events[a])for(var c=this.events[a],d=c.length;d--;)c[d].apply(this,[b||{}])},addEventListener:function(a,b){this.events[a]&&b&&"function"==typeof b&&this.events[a].push(b)},removeEventListener:function(a,b){if(this.events[a])if(b&&"function"==typeof b){var c=this.events[a].indexOf(b);this.events[a].splice(c,1)}else this.events[a].splice(0,this.events[a].length)}}),v=e.Player=u.extend({init:function(a){this._super(),this.name=a||"Player",this.money=0,this.points=0,this.hitpoints=0,this.registerEvent(g.playerDefeated,g.moneyChanged,g.healthChanged)},setMoney:function(a){this.money=a,this.triggerEvent(g.moneyChanged,this)},addMoney:function(a){this.points+=Math.max(0,a),this.setMoney(this.money+a)},getMoney:function(){return this.money},setHitpoints:function(a){this.hitpoints=Math.max(0,a),this.triggerEvent(g.healthChanged,this),0===this.hitpoints&&this.triggerEvent(g.playerDefeated,this)},addHitpoints:function(a){this.setHitpoints(this.hitpoints+a)},getHitpoints:function(){return this.hitpoints},hit:function(a){this.setHitpoints(this.hitpoints-a.damage)}}),w=e.GameObject=u.extend({init:function(a,b,c){this._super(),this.z=0,this.mazeCoordinates=new k,this.speed=b||0,this.animationDelay=c||15,this.dead=!1,this.direction=j.right,this.logic=a},distanceTo:function(a){return a.subtract(this.mazeCoordinates).norm()},update:function(){var a=this.visual;if(a){var b=4===a.frames.length?this.direction:0;a.time+=f.ticks;var c;if(a.direction!==this.direction)for(a.direction=this.direction,a.time=0,a.index=0,c=0;c<b;++c)a.index+=a.frames[c];else if(a.delay<a.time){var d=0;for(a.index++,a.time=0,c=0;c<b;++c)d+=a.frames[c];a.index===d+a.frames[b]&&(a.index=d)}}},getClosestTarget:function(a,b){for(var c,d=Number.MAX_VALUE,e=a.length;e--;){var f=a[e],g=this.distanceTo(f.mazeCoordinates);g<d&&(c=f,d=g)}if(d<=b)return c},playSound:function(a){var b=this.logic&&this.logic.getView();b&&b.playSound(a)},createVisual:function(a,b,c){var d=0,e=0,f=this.logic.getView(),g=f.images&&f.images[a];if(g){for(var h=b.length;h--;)d+=b[h],h<this.direction&&(e+=b[h]);1===b.length&&(e=0),this.visual={direction:this.direction,index:e,time:0,length:d,frames:b,image:g,delay:this.animationDelay,width:g.width/d,height:g.height,scale:c||1}}}}),x=e.Tower=w.extend({init:function(a,b,c,d,e){this._super(a,b,c),this.range=d||0,this.targets=[],this.timeToNextShot=0,this.mazeWeight=0,this.direction=j.left,this.shotType=e||{},this.registerEvent(g.shot)},targetFilter:function(a){return a.strategy!==i.air},update:function(){this._super(this.logic);var a;this.timeToNextShot<=0&&(a=this.shoot()),a?(this.triggerEvent(g.shot,a),this.timeToNextShot=~~(1e3/this.speed)):this.timeToNextShot-=f.ticks},shoot:function(){var a=this.targets.filter(this.targetFilter),b=this.getClosestTarget(a,this.range);if(b){var c=new this.shotType(this.logic);return c.mazeCoordinates=this.mazeCoordinates,c.velocity=b.mazeCoordinates.subtract(this.mazeCoordinates),c.direction=c.velocity.toDirection(),c.targets=a,this.direction=c.direction,c}}}),y=e.Unit=w.extend({init:function(a,b,c,d,e){this._super(a,b,c),this.timer=0,this.path=new t([]),this.mazeCoordinates=new k,this.damage=1,this.strategy=d||i.air,this.hitpoints=e||0,this.health=this.hitpoints,this.direction=j.right,this.registerEvent(g.accomplished,g.died)},playInitSound:function(){this.playSound("humm")},playDeathSound:function(){this.playSound("explosion")},playVictorySound:function(){this.playSound("laugh")},update:function(){this._super(this.logic),this.timer+=f.ticks;var a=.001*this.speed;if(!this.dead&&a>0){var b=this.path.propagate(a*this.timer);b?(this.mazeCoordinates=b.point,this.direction=b.direction):(this.dead=!0,this.triggerEvent(g.accomplished,this),this.playVictorySound())}},hit:function(a){this.health-=a.damage,!this.dead&&this.health<=0&&(this.health=0,this.dead=!0,this.triggerEvent(g.died,this),this.playDeathSound())}}),z=e.Shot=w.extend({init:function(a,b,c,d,e){this._super(a,b,c),this.damage=d||0,this.targets=[],this.impactRadius=e||.5,this.timeToDamagability=~~(200/this.speed),this.velocity=new k,this.registerEvent(g.hit)},update:function(){var a=this.velocity.scale(this.speed*f.ticks*.001);if(this.mazeCoordinates=this.mazeCoordinates.add(a),this._super(this.logic),this.timeToDamagability>0)this.timeToDamagability-=f.ticks;else{var b=this.getClosestTarget(this.targets,this.impactRadius);b&&(b.hit(this),this.dead=!0,this.triggerEvent(g.hit,b))}}}),A=e.GameState={unstarted:0,building:1,waving:2,finished:3},B=e.types={units:{},towers:{},shots:{}},C=e.GameLogic=u.extend({init:function(a,b){var c=this;c._super(),c.towers=[],c.units=[],c.shots=[],c.mediPackCost=f.mediPackCost,c.mediPackFactor=f.mediPackFactor,c.towerBuildCost=f.towerBuildCost,c.towerBuildFactor=f.towerBuildFactor,c.maxTowerNumber=f.towerBuildNumber,c.mediPackHealth=f.mediPackHealth,c.view=a,c.player=new v,c.state=A.unstarted,c.maze=b,c.view.mazeSize=c.getMazeSize(),c.currentWave=null,c.view.setGameLogic(c),c.player.addEventListener(g.playerDefeated,function(a){c.triggerEvent(g.playerDefeated,a),c.finish()}),c.player.addEventListener(g.moneyChanged,function(a){c.triggerEvent(g.moneyChanged,a)}),c.player.addEventListener(g.healthChanged,function(a){c.triggerEvent(g.healthChanged,a)}),c.registerEvent(g.refreshed,g.waveDefeated,g.waveFinished,g.playerDefeated,g.moneyChanged,g.healthChanged,g.waveCreated,g.unitSpawned,g.towerNumberChanged)},start:function(){if(this.state===A.unstarted&&(this.player.setHitpoints(f.hitpoints),this.player.setMoney(f.money),this.triggerEvent(g.towerNumberChanged,{current:this.getNumShooting(),maximum:this.maxTowerNumber}),this.state=A.building),!this.gameLoop){var a=this;this.view.start(),this.gameLoop=setInterval(function(){a.tick()},f.ticks)}},pause:function(){this.gameLoop&&(this.view.pause(),clearInterval(this.gameLoop),this.gameLoop=void 0)},update:function(a){for(var b=a.length;b--;)a[b].update()},tick:function(){if((this.state===A.building||this.state===A.waving)&&(this.update(this.towers),this.state===A.waving)){this.update(this.shots),this.update(this.units),this.removeDeadObjects();for(var a=this.currentWave.update(),b=a.length;b--;){var c=a[b],d=this.maze.getPath();c.mazeCoordinates=this.maze.start,c.path=new t(d),this.addUnit(c)}}},finish:function(){this.state=A.finished},getViewSize:function(){return this.view.getSize()},getNumShooting:function(){return this.towers.length},getMazeSize:function(){return this.maze.gridDim},transformCoordinates:function(a,b){var c=a*this.maze.gridDim.width/this.view.width,d=b*this.maze.gridDim.height/this.view.height;return new k((~~c),(~~d))},removeTower:function(a){a.removeEventListener(g.shot),this.towers.splice(this.towers.indexOf(a),1),this.view.remove(a)},addTower:function(a){var b=this;a.addEventListener(g.shot,function(a){b.addShot(a)}),b.towers.push(a),b.view.add(a)},addShot:function(a){this.shots.push(a),this.view.add(a),a.playInitSound()},addUnit:function(a){var b=this;a.addEventListener(g.accomplished,function(a){b.player.hit(a)}),a.playInitSound(),b.units.push(a),b.view.add(a)},removeDead:function(a){for(var b=a.length;b--;)a[b].dead&&(this.view.remove(a[b]),a.splice(b,1))},removeDeadObjects:function(){this.removeDead(this.towers),this.removeDead(this.shots),this.removeDead(this.units),this.currentWave.finished&&0===this.units.length&&this.endWave()},endWave:function(){this.player.addMoney(this.currentWave.prizeMoney),this.state=A.building;for(var a=this.shots.length;a--;)this.view.remove(this.shots[a]),this.shots.splice(a,1);this.triggerEvent(g.waveDefeated,this.player)},beginWave:function(){if(this.state===A.building){var a=this;a.state=A.waving;var b=a.waves.next();b.addEventListener(g.waveFinished,function(){a.triggerEvent(g.waveFinished),b.removeEventListener(g.waveFinished),b.removeEventListener(g.unitSpawned)}),b.addEventListener(g.unitSpawned,function(b){a.triggerEvent(g.unitSpawned,b)}),a.triggerEvent(g.waveCreated,b),a.currentWave=b}},buildTower:function(a,b){var c=new b(this),d=this.getNumShooting();return!!(this.state===A.building&&b.cost<=this.player.money&&d<this.maxTowerNumber&&(c.mazeCoordinates=a,c.cost=b.cost,c.targets=this.units,this.maze.tryBuild(a,c.mazeWeight)))&&(this.player.addMoney(-b.cost),this.addTower(c),this.triggerEvent(g.towerNumberChanged,{current:d+1,maximum:this.maxTowerNumber}),!0)},destroyTower:function(a){if(this.state==A.building){var b=this.towers.filter(function(b){return b.mazeCoordinates.x===a.x&&b.mazeCoordinates.y===a.y})[0];b&&(this.player.addMoney(.5*b.cost),this.removeTower(b),this.maze.tryRemove(a),this.triggerEvent(g.towerNumberChanged,{current:this.getNumShooting(),maximum:this.maxTowerNumber}))}},getView:function(){var a=this.view;return a},setWaves:function(a){var b=this;return this.waves=a,a&&a.waves.forEach(function(a){a.logic=b}),this}}),D=e.WaveList=h.extend({init:function(a){this.waves=a,this.index=0,this.unitNames=Object.keys(B.units)},next:function(){if(this.index<this.waves.length)return this.waves[this.index++]},setGameLogic:function(a){this.logic=a}}),E=e.Wave=u.extend({init:function(a,b,c){this._super(),this.startTime=0,this.units=c||[],this.prizeMoney=b||0,this.finished=!1,this.registerEvent(g.unitSpawned,g.waveFinished),this.logic=a},add:function(a,b){this.units.push({time:b,unit:a})},update:function(){var a=[];if(!this.finished){for(var b=this.units.length;b--;)this.units[b].time<this.startTime&&(a.push(new B.units[this.units[b].unit](this.logic)),this.units.splice(b,1));if(0===this.units.length&&(this.finished=!0,this.triggerEvent(g.waveFinished)),a.length>0){var c=this.units.length;this.triggerEvent(g.unitSpawned,c)}this.startTime+=f.ticks}return a}}),F=e.Mario=y.extend({init:function(a){this._super(a,F.speed,100,i.manhattan,F.hitpoints),this.createVisual(F.sprite,[8,8,8,8])}},function(a){a.speed=2,a.hitpoints=10,a.description="You have to be careful with that plumber.",a.nickName="Mario",a.sprite="mario",B.units.Mario=a}),G=e.Rope=y.extend({init:function(a){this._super(a,G.speed,80,i.euclideanNoSQR,G.hitpoints),this.createVisual(G.sprite,[4,4,4,4],.8)}},function(a){a.speed=2,a.hitpoints=20,a.description="An ugly rope that tries to conquer the zone. Watch out when they mass up!",a.nickName="Rope",a.sprite="rope",B.units.Rope=a}),H=e.FireWizzrobe=y.extend({init:function(a){this._super(a,H.speed,70,i.manhattan,H.hitpoints),this.createVisual(H.sprite,[3,3,3,3],1.4)}},function(a){a.speed=3,a.hitpoints=30,a.description="The wizard with the fire robe is quite fast, but does not take very much.",a.nickName="Wizzrobe",a.sprite="firewizzrobe",B.units.FireWizzrobe=a}),I=e.AirWolf=y.extend({init:function(a){this._super(a,I.speed,50,i.air,I.hitpoints),this.createVisual(I.sprite,[4])}},function(a){a.speed=2,a.hitpoints=40,a.description="The air wolf is the only aerial unit in the game. Do not underestimate him as an air wolf fleet could kill you.",a.nickName="Wolf",a.sprite="airwolf",B.units.AirWolf=a}),J=e.DarkNut=y.extend({init:function(a){this._super(a,J.speed,80,i.euclideanNoSQR,J.hitpoints),this.createVisual(J.sprite,[4,4,4,4])}},function(a){a.speed=2.5,a.hitpoints=150,a.description="The dark nut is an ancient warrier that takes quite some hits. His speed is superior to most other units.",a.nickName="Dark Nut",a.sprite="darknut",B.units.DarkNut=a}),K=e.Speedy=y.extend({init:function(a){this._super(a,K.speed,25,i.diagonalShortCut,K.hitpoints),this.createVisual(K.sprite,[20])}},function(a){a.speed=5.2,a.hitpoints=200,a.description="This unit is just a single blob. It is ultra fast and has quite some armor. It will give you some trouble.",a.nickName="HAL",a.sprite="newunit",B.units.Speedy=a}),L=e.Armos=y.extend({init:function(a){this._super(a,L.speed,125,i.euclidean,L.hitpoints),this.createVisual(L.sprite,[4,4,4,4],1.2)}},function(a){a.speed=1,a.hitpoints=600,a.description="The unit is actually called Armos and not Armor, however, Armor would have been a good name as well. You will need some fire power to bring him down.",a.nickName="Armos",a.sprite="armos",B.units.Armos=a}),M=e.StandardShot=z.extend({init:function(a){this._super(a,M.speed,15,M.damage,M.impactRadius),this.createVisual(M.sprite,[1],.25)},playInitSound:function(){this.playSound("wowpulse")}},function(a){a.nickName="Standard",a.description="Just an ordinary shot with no special ability.",a.sprite="sunshot",a.frames=1,a.speed=10,a.damage=1,a.impactRadius=.5,B.shots.StandardShot=a}),N=e.AirShot=z.extend({init:function(a){this._super(a,N.speed,10,N.damage,N.impactRadius),this.createVisual(N.sprite,[1,1,1,1],.2)},playInitSound:function(){this.playSound("flak")}},function(a){a.nickName="SAM",a.description="Surface to air missile that is highly effective.",a.sprite="airshot",a.frames=4,a.speed=2.5,a.damage=5,a.impactRadius=.5,B.shots.AirShot=a}),O=e.FlameShot=z.extend({init:function(a){this._super(a,O.speed,100,O.damage,O.impactRadius),this.createVisual(O.sprite,[8])},playInitSound:function(){this.playSound("flames")}},function(a){a.nickName="Red Napalm",a.description="Napalm power you don't want to mess with.",a.sprite="flameshot",a.frames=8,a.speed=1.5,a.damage=8,a.impactRadius=.5,B.shots.FlameShot=a}),P=e.HellShot=z.extend({init:function(a){this._super(a,P.speed,75,P.damage,P.impactRadius),this.createVisual(P.sprite,[12])},playInitSound:function(){this.playSound("hellshot")}},function(a){a.nickName="HDEB",a.description="The High Dark Energy Density is shot by the gate to hell. It catches your soul and gives you the rest.",a.sprite="hellshot",a.frames=12,a.speed=2,a.damage=300,a.impactRadius=.5,B.shots.HellShot=a}),Q=e.IceShot=z.extend({init:function(a){this._super(a,Q.speed,200,Q.damage,Q.impactRadius),this.createVisual(Q.sprite,[4])},playInitSound:function(){this.playSound("icy")}},function(a){a.nickName="Snowball 5",a.description="An experimental super cold plasma (cold is relative here).",a.sprite="iceshot",a.frames=4,a.speed=3.5,a.damage=15,a.impactRadius=.5,B.shots.IceShot=a}),R=e.MGShot=z.extend({init:function(a){this._super(a,R.speed,25,R.damage,R.impactRadius),this.createVisual(R.sprite,[1,1,1,1],.3)},playInitSound:function(){this.playSound("mgnest")}},function(a){a.nickName="Nato cal. 7.72",a.description="Standard MG shot: 7.72 mm full metal jacket that handles most guys.",a.sprite="mgshot",a.frames=4,a.speed=8,a.damage=2,a.impactRadius=.5,B.shots.MGShot=a}),S=e.LaserShot=z.extend({init:function(a){this._super(a,S.speed,25,S.damage,S.impactRadius),this.createVisual(S.sprite,[6,6,6,6])},playInitSound:function(){this.playSound("laser")}},function(a){a.nickName="Faser",a.description="Neutrino shot: Hits before fired (from the perspective of any observer).",a.sprite="lasershot",a.frames=24,a.speed=10,a.damage=7,a.impactRadius=.5,B.shots.LaserShot=a}),T=e.ShellShot=z.extend({init:function(a){this._super(a,T.speed,25,T.damage,T.impactRadius),this.createVisual(T.sprite,[1,1,1,1],.3)},playInitSound:function(){this.playSound("artillery")}},function(a){a.nickName="Shell",a.description="Hardened steel projectile that is no joke.",a.sprite="shellshot",a.frames=4,a.speed=16,a.damage=15,a.impactRadius=.5,B.shots.ShellShot=a}),U=e.MGNest=x.extend({init:function(a){this._super(a,U.speed,25,U.range,U.shotType),this.createVisual(U.sprite,[1])}},function(a){a.description="The MG Nest is cheap but powerful. It can help you a lot against low armored units.",a.nickName="MG Nest",a.sprite="mgnest",a.frames=1,a.shotType=R,a.speed=4,a.range=3,a.cost=7,B.towers.MGNest=a}),V=e.CanonTower=x.extend({init:function(a){this._super(a,V.speed,50,V.range,V.shotType),this.createVisual(V.sprite,[1,1,1,1])}},function(a){a.description="The backbone in war! It has an amazing range and shoots shells, however, the firing speed could be better.",a.nickName="Canon",a.sprite="canontower",a.frames=4,a.shotType=T,a.speed=1,a.range=8,a.cost=12,B.towers.CanonTower=a}),W=e.FlameTower=x.extend({init:function(a){this._super(a,W.speed,200,W.range,W.shotType),this.createVisual(W.sprite,[4])}},function(a){a.description="Burn them down but a bit faster ... Excellent for slow armored units, but fails against strong armored enemies.",a.nickName="Flame tower",a.sprite="flametower",a.frames=4,a.shotType=O,a.speed=6,a.range=2,a.cost=15,B.towers.FlameTower=a}),X=e.IceTower=x.extend({init:function(a){this._super(a,X.speed,200,X.range,X.shotType),this.createVisual(X.sprite,[1,1,1,1])}},function(a){a.description="Cool. Slow shots, but with high efficiency. The right choice against slow strongly armored units.",a.nickName="Ice-Tower",a.sprite="icetower",a.frames=4,a.shotType=Q,a.speed=2,a.range=6,a.cost=25,B.towers.IceTower=a}),Y=e.LaserTower=x.extend({init:function(a){this._super(a,Y.speed,25,Y.range,Y.shotType),this.createVisual(Y.sprite,[1,1,1,1])}},function(a){a.description="Won't play with you, but does it with high efficiency. Really fast low damage shots.",a.nickName="Faser",a.sprite="lasertower",a.frames=4,a.shotType=S,a.speed=3,a.range=5,a.cost=29,B.towers.LaserTower=a}),Z=e.GateToHell=x.extend({init:function(a){this._super(a,Z.speed,200,Z.range,Z.shotType),this.createVisual(Z.sprite,[6])}},function(a){a.description="Paint rules! This is the ultimate weapon of war, but it will not kill high speed units.",a.nickName="Hellgate",a.sprite="gatetohell",a.frames=6,a.shotType=P,a.speed=1,a.range=2,a.cost=55,B.towers.GateToHell=a}),$=e.TowerDefense=d({"static Definition":d({constructor:function(b){a.initialize(this,b).integer("mapHeight",{ignore:!0}).integer("mapWidth",{ignore:!0}).array("creepPath",{ignore:!0}).array("towerPlaces",{ignore:!0}).array("waves",{ignore:!0}).integer("startMoney",{defaultValue:10,coerce:!0}).integer("startHP",{defaultValue:1,coerce:!0})},__maze__:function(){var a=function(a){return new k(a[0],a[1])};return new m(new l(this.mapWidth,this.mapHeight),this.creepPath.map(a),this.towerPlaces.map(a))},__waveList__:function(){return new D(this.waves.map(function(a){return new E(null,a[0],a[1].map(function(a){return{time:a[0],unit:a[1]}}))}))},game:function(b){return new $(a.copy(b||{},{def:this}))}}),constructor:function(b){a.initialize(this,b).object("def").integer("money",{defaultValue:this.def.startMoney,coerce:!0}).integer("hp",{defaultValue:this.def.startHP,coerce:!0}).integer("level",{defaultValue:0,coerce:!0}).array("towers",{ignore:!0}),this.towers||(this.towers=a.Iterable.repeat(null,this.def.towerPlaces.length).toArray())},result:function(){return this.hp<=0?this.level-this.def.waves.length-1:this.level>=this.def.waves.length?this.hp+this.money/f.mediPackCost:null},__logic__:function(a){a=a||new r(0,0);var b=this.def.__maze__(),c=this.def.__waveList__(),d=new C(a,b);return d.state=A.building,d.player.money=999,this.towers.forEach(function(a,c){a&&d.buildTower(b.turrets[c],a)}),d.player.money=this.money,d.player.hitpoints=this.hp,c.index=this.level,d.setWaves(c),d},fromGameLogic:function(b){var c=a.iterable(b.towers).map(function(a){var b=a.mazeCoordinates;return[b.x+","+b.y,a]}).toObject();return new this.constructor({def:this.def,money:b.player.money,hp:b.player.hitpoints,level:b.waves.index,towers:b.maze.turrets.map(function(a){var b=c[a.x+","+a.y];return b?b.constructor:null})})},next:function(b){for(var c=this,d=this.__logic__(),e=0;e<b.length;e++)b[e]!==this.towers[e]&&this.towers[e]&&d.destroyTower(d.maze.turrets[e]);for(e=0;e<b.length;e++)b[e]&&b[e]!==this.towers[e]&&b[e].cost<=d.player.money&&d.buildTower(d.maze.turrets[e],b[e]);var f=new a.Future;return d.addEventListener(g.playerDefeated,function(){f.resolve(d)}),d.addEventListener(g.waveDefeated,function(){f.resolve(d)}),d.start(),d.beginWave(),f.then(function(a){return a.pause(),c.fromGameLogic(a)})},toString:function(){return"TowerDefense("+this.money+","+this.hp+","+this.level+",["+this.towers.map(function(a){return a?a.nickName:""}).join(",")+"])"}});e.AIPlayer=d({constructor:function(a){a=a||{},this.name=a.name||"AIPlayer",this.size=+a.size||10,this.steps=+a.steps||10,this.expansionRate=+a.expansionRate||.5,this.mutationRate=+a.mutationRate||.25},Problem:d(c.Problem,{constructor:function(b){b.objectives=+(1/0),c.Problem.call(this,b),this.game=b.game,this.towerTypes=a.iterable(B.towers).select(1).toArray();var d={min:0,max:this.towerTypes.length+1,discrete:!0};this.__elementModel__=a.Iterable.repeat(d,this.game.def.towerPlaces.length).toArray()},mapping:function(a){var b=this;return a.values.map(function(a){return b.towerTypes[a]||null})},emblem:function(a){var b=this.mapping(a);return"["+b.map(function(a){return a?a.nickName:""}).join("|")+"]"},evaluation:function(a){var b=this.mapping(a);return this.game.next(b).then(function(a){var b=a.hp+a.money/f.mediPackCost;return b})}}),decision:function(a){var b=new this.Problem({game:a}),d=new c.metaheuristics.GeneticAlgorithm({problem:b,size:this.size,steps:this.steps,expansionRate:this.expansionRate,mutationRate:this.mutationRate});return d.events.on("advanced",function(){for(d.nub();d.state.length<d.size;)d.state.push(b.newElement())}),d.run().then(function(a){return a.mapping()})},play:function(b,c){var d=this;return a.Future.doWhile(function(a){return a=a||b,d.decision(a).then(function(b){return a.next(b).then(function(d){
return c&&c(a,b,d),d})})},function(a){return!a.result()})}}),e.scenarios={Test01:new $.Definition({mapWidth:8,mapHeight:8,creepPath:[[1,0],[1,1],[1,2],[1,3],[1,4],[2,4],[3,4],[3,5],[3,6],[4,6],[5,6],[5,5],[5,4],[5,3],[5,2],[5,1],[5,0]],towerPlaces:[[2,3],[4,5],[4,3],[2,1],[2,5]],waves:[[10,[[1,"Mario"],[400,"Mario"],[1e3,"Rope"],[1200,"Rope"]]],[12,[[1,"Mario"],[350,"Rope"],[850,"Mario"],[1100,"Mario"],[1800,"Rope"],[2500,"Rope"]]],[16,[[1,"Mario"],[350,"Rope"],[500,"FireWizzrobe"],[1e3,"Rope"],[1500,"FireWizzrobe"]]],[20,[[1,"Speedy"],[200,"FireWizzrobe"],[500,"Rope"],[600,"FireWizzrobe"],[900,"FireWizzrobe"],[1300,"FireWizzrobe"],[2800,"DarkNut"]]],[22,[[1,"FireWizzrobe"],[600,"Rope"],[1500,"FireWizzrobe"],[2e3,"Rope"],[2800,"FireWizzrobe"],[3700,"DarkNut"],[4500,"DarkNut"],[6e3,"FireWizzrobe"]]],[25,[[1,"DarkNut"],[500,"FireWizzrobe"],[1e3,"FireWizzrobe"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"]]],[25,[[1,"DarkNut"],[600,"FireWizzrobe"],[1e3,"DarkNut"],[2200,"Rope"],[2500,"Rope"],[2600,"Rope"],[4e3,"FireWizzrobe"],[4900,"FireWizzrobe"],[6e3,"Armos"]]],[30,[[1,"DarkNut"],[1e3,"DarkNut"],[2200,"FireWizzrobe"],[2800,"FireWizzrobe"],[4e3,"Armos"],[5e3,"DarkNut"],[5400,"FireWizzrobe"],[6e3,"FireWizzrobe"]]],[50,[[1,"Armos"],[1e3,"Rope"],[1400,"Rope"],[3e3,"Armos"],[4800,"FireWizzrobe"],[5100,"FireWizzrobe"],[6e3,"Armos"],[7100,"DarkNut"],[7800,"DarkNut"],[8500,"Armos"],[1e4,"Armos"]]],[25,[[1,"Armos"],[1e3,"Armos"],[2e3,"Armos"],[3e3,"Armos"],[4e3,"Armos"],[5e3,"Armos"]]]],startMoney:25,startHP:10}),Test02:new $.Definition({mapWidth:8,mapHeight:8,creepPath:[[0,4],[1,4],[2,4],[2,5],[2,6],[3,6],[4,6],[4,5],[4,4],[4,3],[4,2],[5,2],[6,2],[7,2]],towerPlaces:[[3,4],[1,5],[5,3]],waves:[[10,[[1,"Mario"],[400,"Mario"],[1e3,"Rope"],[1200,"Rope"]]],[12,[[1,"Mario"],[350,"Rope"],[850,"Mario"],[1100,"Mario"],[1800,"Rope"],[2500,"Rope"]]],[16,[[1,"Mario"],[350,"Rope"],[500,"FireWizzrobe"],[800,"FireWizzrobe"],[1e3,"Rope"],[1500,"FireWizzrobe"]]],[20,[[1,"Speedy"],[200,"FireWizzrobe"],[500,"Rope"],[550,"Rope"],[600,"FireWizzrobe"],[680,"Rope"],[900,"FireWizzrobe"],[1300,"FireWizzrobe"],[2800,"DarkNut"]]],[22,[[1,"FireWizzrobe"],[500,"Rope"],[550,"Rope"],[1e3,"FireWizzrobe"],[1200,"Rope"],[1350,"Rope"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"],[4200,"FireWizzrobe"]]],[25,[[1,"DarkNut"],[500,"FireWizzrobe"],[1e3,"FireWizzrobe"],[1200,"DarkNut"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"],[4200,"DarkNut"]]],[20,[[1,"DarkNut"],[250,"FireWizzrobe"],[600,"FireWizzrobe"],[1e3,"DarkNut"],[2200,"Rope"],[2300,"Rope"],[2400,"Rope"],[2500,"Rope"],[2600,"Rope"],[4e3,"FireWizzrobe"],[4200,"DarkNut"],[4400,"FireWizzrobe"],[6e3,"Armos"]]],[25,[[1,"DarkNut"],[250,"DarkNut"],[600,"DarkNut"],[1e3,"DarkNut"],[2200,"FireWizzrobe"],[2300,"FireWizzrobe"],[2400,"Rope"],[2500,"Rope"],[2600,"FireWizzrobe"],[4e3,"Armos"],[5e3,"DarkNut"],[5400,"FireWizzrobe"],[6e3,"FireWizzrobe"],[8e3,"Armos"]]],[30,[[1,"Armos"],[1e3,"Rope"],[1300,"Rope"],[1400,"Rope"],[3e3,"Armos"],[3100,"FireWizzrobe"],[3300,"FireWizzrobe"],[3400,"FireWizzrobe"],[5e3,"Armos"],[5100,"DarkNut"],[5300,"DarkNut"],[5400,"DarkNut"],[6500,"Armos"],[7e3,"Armos"]]],[25,[[1,"Armos"],[1e3,"Armos"],[2e3,"Armos"],[3e3,"Armos"],[4e3,"Armos"],[5e3,"Armos"]]]],startMoney:15,startHP:10}),Test03:new $.Definition({mapWidth:8,mapHeight:8,creepPath:[[0,4],[1,4],[2,4],[3,4],[4,4],[4,3],[4,2],[5,2],[6,2],[7,2]],towerPlaces:[[2,3],[4,5],[5,3],[2,5]],waves:[[8,[[1,"Mario"],[700,"Mario"],[1800,"Rope"],[2800,"Rope"],[4e3,"DarkNut"]]],[8,[[1,"Mario"],[350,"Mario"],[700,"Mario"],[1800,"Rope"],[2300,"Rope"],[2800,"Rope"],[3800,"FireWizzrobe"],[5e3,"DarkNut"]]],[9,[[1,"Mario"],[350,"Rope"],[400,"Mario"],[600,"Rope"],[800,"Rope"],[1e3,"Rope"],[1500,"FireWizzrobe"]]],[12,[[1,"FireWizzrobe"],[450,"Rope"],[600,"FireWizzrobe"],[900,"FireWizzrobe"],[1200,"FireWizzrobe"]]],[15,[[1,"FireWizzrobe"],[500,"Rope"],[550,"Rope"],[600,"Rope"],[650,"Rope"],[700,"Rope"],[1600,"FireWizzrobe"],[4e3,"FireWizzrobe"],[4200,"FireWizzrobe"]]],[20,[[1,"DarkNut"],[500,"FireWizzrobe"],[1e3,"FireWizzrobe"],[1200,"DarkNut"],[1600,"FireWizzrobe"],[2500,"DarkNut"],[3e3,"DarkNut"],[4e3,"FireWizzrobe"],[4200,"DarkNut"]]],[20,[[1,"DarkNut"],[250,"FireWizzrobe"],[600,"FireWizzrobe"],[1e3,"DarkNut"],[2200,"Rope"],[2300,"Rope"],[2400,"Rope"],[2500,"Rope"],[2600,"Rope"],[4e3,"FireWizzrobe"],[4200,"DarkNut"],[4400,"FireWizzrobe"],[6e3,"Armos"]]],[25,[[1,"DarkNut"],[250,"DarkNut"],[600,"DarkNut"],[1e3,"DarkNut"],[2200,"FireWizzrobe"],[2300,"FireWizzrobe"],[2400,"Rope"],[2500,"Rope"],[2600,"FireWizzrobe"],[4e3,"Armos"],[5e3,"DarkNut"],[5400,"FireWizzrobe"],[6e3,"FireWizzrobe"],[8e3,"Armos"]]],[30,[[1,"Armos"],[1e3,"Rope"],[1300,"Rope"],[1400,"Rope"],[3e3,"Armos"],[3100,"FireWizzrobe"],[3300,"FireWizzrobe"],[3400,"FireWizzrobe"],[5e3,"Armos"],[5100,"DarkNut"],[5300,"DarkNut"],[5400,"DarkNut"],[6500,"Armos"],[7e3,"Armos"]]],[25,[[1,"Armos"],[1e3,"Armos"],[2e3,"Armos"],[3e3,"Armos"],[4e3,"Armos"],[5e3,"Armos"]]]],startMoney:14,startHP:10})};return e});
//# sourceMappingURL=ludorum-towerdefense.min.js.map